#!/bin/bash
#
# vi: set ft=sh :

set -u
set -e

ENV=production
DESC="app-passenger-<%= name %>"
TCP_PORT="<%= port %>"
UNX_PORT="/tmp/<%= name %>.socket"
USR_NAME="<%= duser %>"
APP_NAME="<%= name %>"
APP_ROOT="<%= root_dir %>/current"
LOG_FILE="<%= root_dir %>/shared/log/$ENV.log"
PID_FILE="<%= root_dir %>/shared/pids/$DESC.pid"

CONNECT_METHOD="-p $TCP_PORT"
[ "$TCP_PORT" == "unix_socket" ] && CONNECT_METHOD="-S $UNX_PORT"

PASSENGER_ARG="$CONNECT_METHOD -e $ENV -R config.ru -d --log-file $LOG_FILE --pid-file $PID_FILE"
PASSENGER_CMD="cd $APP_ROOT && $APP_ROOT/bin/passenger"

CMD_STOP="$PASSENGER_CMD stop --pid-file $PID_FILE"
CMD_START="$PASSENGER_CMD start $PASSENGER_ARG"
CMD_STATUS="$PASSENGER_CMD status --pid-file $PID_FILE"

alive () {
	test -s "$PID_FILE" && kill -0 `cat $PID_FILE`
}

cd $APP_ROOT || exit 1

case ${1-help} in
start)
  echo "Starting $DESC: "
	alive && { echo "Already started" ; exit 0 ; }
	su - $USR_NAME -c "$CMD_START"
  echo "$APP_NAME."
  exit 0
	;;
stop)
  echo "Stopping $DESC: "
	alive || { echo "Already stopped" ; exit 0 ; }
	su - $USR_NAME -c "$CMD_STOP"
  echo "$APP_NAME."
  exit 0
	;;
restart)
  echo "Restarting $DESC: "
  alive && { su - $USR_NAME -c "$CMD_STOP" ; } 
	su - $USR_NAME -c "$CMD_START"
  echo "$APP_NAME."
  exit 0
	;;
status)
  echo "Status for $DESC: "
	su - $USR_NAME -c "$CMD_STATUS"
  echo "$APP_NAME."
  exit 0
	;;
*)
 	echo >&2 "Usage: $0 <start|stop|restart|force-stop|status>"
 	exit 1
 	;;
esac
