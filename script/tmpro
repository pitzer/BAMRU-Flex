#!/usr/bin/env bash

tmux has-session -t flex

# create a new session if none exists
if [ $? != 0 ] ; then

  tmux new-session -s flex -n sysmon -d

  tmux split-window -t flex:1 -v
  tmux split-window -t flex:1 -h
  tmux send-keys -t flex:1.1 'htop'  C-m
  tmux send-keys -t flex:1.2 'sudo iotop' C-m
  tmux send-keys -t flex:1.3 'sudo iftop' C-m

  tmux new-window  -t flex -n ngxlog
  tmux send-keys -t flex:2 'multitail /var/log/nginx/access.log /var/log/nginx/error.log' C-m

  tmux new-window  -t flex -n applog

  tmux select-window -t flex:1

fi

# get a count of active clients
count=`tmux list-clients | grep flex | wc -l`

# if there are no clients, then attach directly to the session
[ $count == 0 ] && tm attach -t flex && exit 0

# if there are attached clients, then attach using a Grouped
# Session (this enabled different clients to view different pages)
while [ true ] ; do # loop until an available client-id is found...
  client_count=`tmux list-clients | grep flex$count | wc -l`
  session_count=`tmux list-sessions | grep flex$count | wc -l`
  if [ $client_count == 0 ] ; then
    [ $session_count != ] && tmux kill-session -t flex$count
    tmux new-session -t flex -s flex$count
    exit 0
  fi
  count=$count+1
done
